name: Deploy (self-hosted)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 60

    steps:
      # 1️⃣ Checkout latest code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2️⃣ Set up Docker Buildx (for better caching and features)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 3️⃣ Build Docker image with caching enabled
      - name: Build and load Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          # Load the image into the local Docker daemon instead of pushing to a registry
          load: true
          # 'cache-from' and 'cache-to' enable intelligent caching
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: rigbot:latest

      # 4️⃣ Cleanup dangling images (safer to run this after a successful build)
      - name: Cleanup old images
        run: docker image prune -f

      # 5️⃣ Restart container with latest image
      - name: Restart container
        run: |
          docker rm -f rigbot || true
          docker run -d --name rigbot --restart unless-stopped \
            -p 8080:8000 \
            --env-file /home/ubuntu/rigbot/.env \
            -v /data/rigbot/source_pdfs:/app/app/data/source_pdfs \
            -v /data/rigbot/vectorstore:/app/app/data/vectorstore \
            -v /data/rigbot/hf_cache:/root/.cache/huggingface \
            rigbot:latest