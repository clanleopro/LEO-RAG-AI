name: Deploy (self-hosted)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ðŸ”¹ Set up Docker Buildx (modern builder with cache support)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ðŸ”¹ Build & cache the image
      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: rigbot:latest
          cache-from: type=local,src=/home/ubuntu/.buildx-cache
          cache-to: type=local,dest=/home/ubuntu/.buildx-cache,mode=max

      - name: Cleanup old images
        run: docker image prune -f

      # ðŸ”¹ Restart container with latest image
      - name: Restart container
        run: |
          docker rm -f rigbot || true
          docker run -d --name rigbot --restart unless-stopped \
            -p 8080:8000 \
            --env-file /home/ubuntu/rigbot/.env \
            -v /data/rigbot/source_pdfs:/app/app/data/source_pdfs \
            -v /data/rigbot/vectorstore:/app/app/data/vectorstore \
            -v /data/rigbot/hf_cache:/root/.cache/huggingface \
            rigbot:latest
