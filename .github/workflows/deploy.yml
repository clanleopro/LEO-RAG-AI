name: Deploy to EC2

on:
  push:
    branches: ["main"]   # runs when you push to main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "."
        target: "~/rigbot"

    - name: Rebuild and restart container on EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd ~/rigbot
          echo "üßπ Cleaning old Docker images..."
          docker system prune -af || true

          echo "üê≥ Building new Docker image..."
          docker build --no-cache -t rigbot .

          echo "üõë Stopping old container..."
          docker rm -f rigbot || true

          echo "üöÄ Starting new container..."
          docker run -d --name rigbot --restart unless-stopped \
            -p 80:8000 \
            --env-file .env \
            -v /data/rigbot/source_pdfs:/app/app/data/source_pdfs \
            -v /data/rigbot/vectorstore:/app/app/data/vectorstore \
            -v /data/rigbot/hf_cache:/root/.cache/huggingface \
            rigbot
          echo "‚úÖ Deployment complete!"
