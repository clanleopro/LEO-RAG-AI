name: Deploy (self-hosted)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted
    timeout-minutes: 60

    steps:
      # 1️⃣ Checkout latest code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Build Docker image fresh (no cache)
      - name: Build Docker image
        run: |
          docker build --no-cache --pull -t rigbot:latest .

      # 3️⃣ Cleanup dangling images (optional)
      - name: Cleanup old images
        run: docker image prune -f

      # 4️⃣ Restart container with latest image
      - name: Restart container
        run: |
          docker rm -f rigbot || true
          docker run -d --name rigbot --restart unless-stopped \
            -p 8080:8000 \
            --env-file /home/ubuntu/rigbot/.env \
            -v /data/rigbot/source_pdfs:/app/app/data/source_pdfs \
            -v /data/rigbot/vectorstore:/app/app/data/vectorstore \
            -v /data/rigbot/hf_cache:/root/.cache/huggingface \
            rigbot:latest
