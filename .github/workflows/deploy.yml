name: Deploy (self-hosted)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted   # ðŸ‘ˆ runs on your EC2
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Build Docker image
      run: |
        cd ~/rigbot
        docker system prune -af || true
        docker build -t rigbot .

    - name: Restart container
      run: |
        docker rm -f rigbot || true
        docker run -d --name rigbot --restart unless-stopped \
          -p 80:8000 \
          --env-file /home/ubuntu/rigbot/.env \
          -v /data/rigbot/source_pdfs:/app/app/data/source_pdfs \
          -v /data/rigbot/vectorstore:/app/app/data/vectorstore \
          -v /data/rigbot/hf_cache:/root/.cache/huggingface \
          rigbot
